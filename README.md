# MapleRoyals APQ 组队插件

## 项目简介

本插件是为 MapleRoyals 游戏中 APQ (Amoria Party Quest) 活动设计的组队管理插件。APQ 是需要男女搭配完成的情侣活动，每个队伍最多 6 人参与，参与者需要提供角色信息（角色ID、新娘/新郎、职业）。

## 项目结构

```
astrbot_plugin_mapleroyalsapq/
├── metadata.yaml          # 插件元数据
├── main.py               # 主程序代码
├── _conf_schema.json     # 配置文件模式
├── README.md             # 本文档
└── database.json         # 数据库
```

## 功能特性

### 核心功能

1. **开启APQ** - 创建一个新的 APQ 组队会话
2. **加入APQ** - 加入现有的 APQ 组队，需要提供角色信息
3. **集结完成** - 完成集结，显示最终队伍分配
4. **查询APQ** - 查询当前组队状态和参与者信息

### APQ 规则

- 每个队伍最多 6 人参与
- 参与者必须提供以下信息：
  - **角色ID**: 游戏内角色唯一标识
  - **性别角色**: 新娘(br) 或 新郎(gr)
  - **职业信息**: 角色职业（如：夜行者、火枪手、船长等）

## 用户命令

### 1. 创建APQ

```
/创建APQ <角色ID> <br/gr/新郎/新娘> <职业>
```

**说明**: 创建一个新的 APQ 组队会话，并自动加入

**参数说明**:
- `角色ID`: 游戏内角色ID（必填）
- `br/gr/新郎/新娘`: 性别角色，支持 br/新娘 或 gr/新郎（必填）
- `职业`: 角色职业名称（必填）

**示例**:
```
/创建APQ dingzhen gr 拳手
/创建APQ xuebao 新郎 法师
/创建APQ litang br 小号
```

**说明**:
- 每队固定 6 人

- 创建者自动加入APQ

- 最多允许1个APQ活动状态为召集中

- 在database.json存储时，默认要在最后加上用户的QQ号比如/创建APQ litang br 小号最终执行之后是 /创建APQ litang br 小号 QQ号：123456789

  

### 2. 加入APQ

```
/APQ加入 <角色ID> <br/gr/新郎/新娘> <职业>
```

**说明**: 加入 APQ 组队，需要提供完整的角色信息

**参数说明**:
- `角色ID`: 游戏内角色ID（必填）
- `br/gr/新郎/新娘`: 性别角色，支持 br/新娘 或 gr/新郎（必填）代码要写死只能出现br/gr/新郎/新娘，字母不区分大小写
- `职业`: 角色职业名称（必填）
- 代码用空格进行分割识别，可以是一个空格也能是多个空格

**示例**:
```
/APQ加入 12345 br 刀飞
/APQ加入 67890     gr 船长
/APQ加入 12345 新娘       标飞
/APQ加入    67890 新郎 船长
```

**规则**:
- 用户必须输入对应格式的内容才能被接受，交换信息无法参加比如/APQ加入      船长  新郎 船长 张德帅，这种信息错位无法参加成功，代码要写死

### 3. 更换角色

```
/APQ更换 <角色ID> <br/gr/新郎/新娘> <职业>
```

**说明**: 更换自己的角色信息，活动创建者或者管理员可以更换他人的信息

**参数说明**:
- `角色ID`: 新的游戏内角色ID（必填）
- `br/gr/新郎/新娘`: 性别角色，支持 br/新娘 或 gr/新郎（必填）
- `职业`: 新的角色职业名称（必填）

**示例**:
```
/APQ更换 dingzhen2 gr 拳手
/APQ更换 xuebao2 新郎 法师
```

**说明**:
- 普通用户和活动创建者只能修改自己的信息
- 管理员可以修改任何人的信息
- 代码是基于database.json中的QQ号去查询对应角色信息并编辑的对应那一行的

### 4. 删除角色

```
/APQ删除 <角色ID>
```

**说明**: 从APQ中删除指定角色

**示例**:
```
/APQ删除 dingzhen
/APQ删除 12345
```

**权限**: 管理员

### 5. 集结完成

```
/APQ完成
```

**说明**: 完成集结，显示最终队伍名单，并清空database.json的数据，以准备下一场APQ活动

**功能**:
- 显示最终队伍名单
- 清空database.json的数据

### 6. 查询APQ

```
/APQ查询
```

**说明**: 查询当前 APQ 组队状态

**显示内容**:

- 队伍的参与者信息（角色ID、性别、职业，QQ号）

### 7. 取消APQ

```
/APQ取消
```

**说明**: 创建者取消自己的 APQ 活动，直接清空database.json的数据

### 8. 重置APQ

```
/APQ重置
```

**说明**: 取消自己的 APQ 活动，直接清空database.json的数据



## 数据结构

### 参与者信息

```python
{
    "role": "leader",
    "user_id": "QQ号",
    "character_id": "角色ID",
    "gender": "br/gr",  # 新娘/新郎
    "job": "职业"
}
```

### 队伍结构配置说明

### _conf_schema.json

```json
{
  "admin_ids": {
    "type": "list",
    "description": "超级管理员ID列表",
    "items": {
      "type": "string"
    },
    "default": []
  }
}
```

## 技术实现

### 核心功能

- 单一会话管理（全局 APQ 组队）
- 数据持久化（JSON 格式存储）
- 管理员权限控制
- 角色信息验证
- 自动队伍分配

### 新增功能

1. **角色信息验证**
   - 验证角色ID格式
   - 验证性别参数（只能是 br/gr）
   - 职业信息记录

2. **队伍分配逻辑**
   - 优先填充现有队伍空缺
   - 自动创建新队伍
   - 每队最多 6 人

3. **信息展示**
   - 显示每个参与者的完整信息
   - 队伍性别搭配统计
   - 职业分布情况

## 版本计划

### v1.0.0 (初始版本)
- 基础组队功能

- 角色信息收集

- 队伍查询和显示

  



## 使用场景

```
[玩家A] /创建APQ dingzhen gr 拳手
[玩家B] /APQ加入 12345 br 夜行者
[玩家B] /APQ加入 67890 gr 船长
[玩家C] /APQ加入 11111 br 主教
[玩家D] /APQ加入 22222 gr 暗影神偷
[玩家E] /APQ加入 33333 br 复活者
[玩家F] /APQ加入 44444 gr 勇士

```

## 注意事项

1. APQ 活动需要男女搭配参与
2. 每个队伍最多 6 人
3. 所有用户都可以使用基础命令（创建、加入、查询、完成、取消）
4. 管理员拥有额外权限：更换他人角色、删除角色、重置APQ
5. 数据会持久化保存，重启后不丢失

## 管理员权限

管理员可以执行以下特殊操作：
- `/APQ更换 <角色ID> <br/gr/新郎/新娘> <职业>` - 修改任何人的角色信息
- `/APQ删除 <角色ID>` - 从APQ中移除指定角色
- `/APQ重置` - 重置整个APQ数据
