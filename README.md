# MapleRoyals APQ 组队插件

## 项目简介

本插件是为 MapleRoyals 游戏中 APQ (Amoria Party Quest) 活动设计的组队管理插件。APQ 是需要男女搭配完成的情侣活动，每个队伍最多 6 人参与，参与者需要提供角色信息（角色ID、新娘/新郎、职业）。

**作者**: jarecl
**版本**: 1.0.0
**仓库**: https://github.com/jarecl/astrbot_plugin_mapleroyalsapq

---

## 功能特性

- **创建APQ** - 创建一个新的 APQ 组队会话，创建者自动加入
- **加入APQ** - 加入现有的 APQ 组队，需要提供角色信息
- **查询APQ** - 查询当前组队状态和参与者信息
- **我的APQ** - 查询自己的报名状态
- **更换角色** - 更新自己的角色信息
- **完成APQ** - 完成集结，显示最终队伍分配并清空数据
- **取消APQ** - 取消当前APQ活动，清空所有数据
- **管理员功能** - 删除指定角色、重置APQ数据

---

## APQ 规则

- 每个队伍最多 6 人参与
- 参与者必须提供以下信息：
  - **角色ID**: 游戏内角色唯一标识
  - **性别角色**: 新娘(br) 或 新郎(gr)
  - **职业信息**: 角色职业（如：夜行者、火枪手、船长等）

---

## 安装说明

### 前置要求

- [AstrBot](https://github.com/Soulter236/AstrBot) 框架
- Python 3.8+

### 安装步骤

1. 将插件目录 `astrbot_plugin_mapleroyalsapq` 放入 AstrBot 的 `plugins` 目录
2. 重启 AstrBot 或使用插件重载命令
3. 配置管理员ID（可选）

---

## 配置说明

在 AstrBot 配置中设置超级管理员ID：

```json
{
  "admin_ids": ["123456789", "987654321"]
}
```

超级管理员拥有以下额外权限：
- 更新任意玩家的角色信息
- 删除指定角色
- 重置整个APQ数据

---

## 项目结构

```
astrbot_plugin_mapleroyalsapq/
├── metadata.yaml          # 插件元数据
├── main.py               # 主程序代码
├── _conf_schema.json     # 配置文件模式
├── README.md             # 本文档
└── database.json         # 数据库（运行时生成）
```

---

## 用户命令

### 1. 创建APQ

```
/创建APQ <角色ID> <br/gr/新郎/新娘> <职业>
```

**说明**: 创建一个新的 APQ 组队会话，并自动加入

**参数说明**:
- `角色ID`: 游戏内角色ID（必填）
- `br/gr/新郎/新娘`: 性别角色，支持 br/新娘 或 gr/新郎（必填，不区分大小写）
- `职业`: 角色职业名称（必填）

**示例**:
```
/创建APQ dingzhen gr 拳手
/创建APQ xuebao 新郎 法师
/创建APQ litang br 小号
```

**规则**:
- 每队固定 6 人
- 创建者自动成为队长并加入APQ
- 同时只能有一个APQ活动处于召集中
- 如果已有APQ在召集，第二个人创建时会收到提示：目前已有APQ在召集，请等满员发车后再创建新的
- 用户QQ号会自动记录在database.json中

---

### 2. 加入APQ

```
/加入APQ <角色ID> <br/gr/新郎/新娘> <职业>
```

**说明**: 加入 APQ 组队，需要提供完整的角色信息

**参数说明**:
- `角色ID`: 游戏内角色ID（必填）
- `br/gr/新郎/新娘`: 性别角色，支持 br/新娘 或 gr/新郎（必填，不区分大小写）
- `职业`: 角色职业名称（必填）

**业务逻辑**:
- 如果database.json中没有APQ活动，回复：目前没有进行中的APQ活动，请先创建APQ
- 如果有APQ活动，正常添加信息并回复当前所有已参与的成员信息
- 当第6个人加入时，先回复6人名单，然后重置database.json

**示例**:
```
/加入APQ 12345 br 刀飞
/加入APQ 67890     gr 船长
/加入APQ 12345 新娘       标飞
```

**规则**:
- 必须按正确格式输入（角色ID、性别、职业）
- 参数顺序固定，无法交换
- 支持多个空格分隔
- 代码严格验证格式，信息错位无法参加

---

### 3. 查询APQ

```
/查询APQ
```

**说明**: 查询当前 APQ 组队状态

**显示内容**:
- 已分配队伍信息（队伍名、人数、成员详情）
- 自由报名池中的玩家
- 统计信息（总人数、新娘数、新郎数）

---

### 4. 我的APQ

```
/我的APQ
```

**说明**: 查询自己的 APQ 报名状态

**显示内容**:
- 当前所在队伍或自由报名池
- 自己的角色ID、性别、职业信息
- 队伍人数（如已分配）

---

### 5. 更换角色

```
/更换APQ角色 <角色ID> <br/gr/新郎/新娘> <职业>
```

**说明**: 更换自己的角色信息，管理员可以更换他人的信息

**参数说明**:
- `角色ID`: 新的游戏内角色ID（必填）
- `br/gr/新郎/新娘`: 性别角色（必填）
- `职业`: 新的角色职业名称（必填）

**业务逻辑**:
- 基于QQ号查询并更新对应角色信息
- 如果用户没有加入APQ，回复：先加入APQ

**示例**:
```
/更换APQ角色 dingzhen2 gr 拳手
/更换APQ角色 xuebao2 新郎 法师
```

---

### 6. 取消APQ

```
/取消APQ
```

**说明**: 仅限APQ创建者使用，需要发送此条消息的QQ号是否和database.json中的队长的qq号一致，如果一致则取消当前的 APQ 活动，直接清空database.json的活动相关数据，等待新的APQ活动创建

---

### 7. 帮助

```
/APQ命令使用帮助
```

**说明**: 显示所有可用命令的帮助信息

---

## 管理员命令

### 删除角色

```
/删除APQ <角色ID>
```

**权限**: 超级管理员 或 群管理员

**说明**: 从APQ中移除指定角色

**示例**:
```
/删除APQ dingzhen
```

---

### 重置APQ

```
/重置APQ
```

**权限**: 超级管理员 或 群管理员

**说明**: 完全重置APQ数据，清空所有活动

---

## 使用场景示例

```
[玩家A] /创建APQ dingzhen gr 拳手
[玩家B] /加入APQ 12345 br 夜行者
[玩家C] /加入APQ 67890 gr 船长
[玩家D] /加入APQ 11111 br 主教
[玩家E] /加入APQ 22222 gr 暗影神偷
[玩家F] /加入APQ 33333 br 复活者
[玩家G] /加入APQ 44444 gr 勇士
-> 第6个人加入后，自动完成并重置
```

---

## 数据结构

### 参与者信息

```python
{
    "user_id": "QQ号",
    "nickname": "用户昵称",
    "character_id": "角色ID",
    "gender": "br/gr",  # 新娘/新郎
    "job": "职业",
    "qq_number": "QQ号"
}
```

### 全局状态

```python
{
    "status": "idle/recruiting/completed",
    "captain": {
        "qq_number": "队长QQ号",
        "nickname": "队长昵称",
        "character_id": "队长角色ID",
        "gender": "br/gr",
        "job": "队长职业"
    },
    "members": [
        {
            "qq_number": "队员QQ号",
            "nickname": "队员昵称",
            "character_id": "队员角色ID",
            "gender": "br/gr",
            "job": "队员职业"
        },
        ...
    ]
}
```

**说明**：
- `captain`: 队长信息（创建APQ的人）
- `members`: 参加者信息列表（包含队长，最多6人）
- 同时只能有一个APQ活动处于召集中

---

## 配置文件说明

### _conf_schema.json

```json
{
  "admin_ids": {
    "type": "list",
    "description": "超级管理员ID列表",
    "items": {
      "type": "string"
    },
    "default": []
  }
}
```

---

## 技术实现

### 核心功能

- 单一会话管理（全局 APQ 组队）
- 数据持久化（JSON 格式存储）
- 管理员权限控制（超级管理员+群管理员）
- 角色信息严格验证
- 自动队伍分配（随机算法）

### 权限系统

1. **超级管理员**: 配置文件中 `admin_ids` 指定的用户
2. **群管理员**: 群主、群管理员等拥有群管理权限的用户

---

## 注意事项

1. APQ 活动需要男女搭配参与
2. 每个队伍最多 6 人
3. 所有用户都可以使用基础命令（创建、加入、查询、更换、取消）
4. 管理员拥有额外权限：更换他人角色、删除角色、重置APQ
5. 数据会持久化保存到 `database.json`，重启后不丢失
6. 当第6个人加入APQ时，系统会自动完成集结并重置数据

---

## 常见问题

**Q: 命令提示格式错误？**
A: 确保按照 `角色ID 性别 职业` 的顺序输入，性别只能用 br/gr/新郎/新娘

**Q: 如何查看自己的报名状态？**
A: 使用 `/我的APQ` 命令

**Q: 可以重复报名吗？**
A: 不可以，新的报名会覆盖之前的报名信息

**Q: 怎么结束当前APQ活动？**
A: 使用 `/APQ完成` 显示最终结果并重置，或 `/取消APQ` 直接取消

**Q: 管理员有什么特殊权限？**
A: 管理员可以删除指定角色、重置整个APQ数据、更换任意玩家的角色信息

---

## 版本历史

### v1.0.0
- 基础组队功能
- 角色信息收集
- 队伍查询和显示
- 管理员权限系统
- 数据持久化
