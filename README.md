# MapleRoyals APQ 组队插件

## 项目简介

本插件是为 MapleRoyals 游戏中 APQ (Amoria Party Quest) 活动设计的组队管理插件。APQ 是需要男女搭配完成的情侣活动，每个队伍最多 6 人参与，参与者需要提供角色信息（角色ID、新娘/新郎、职业）。

**作者**: jarecl
**版本**: 1.1.0
**仓库**: https://github.com/jarecl/astrbot_plugin_mapleroyalsapq

---

## 功能特性

### 用户功能
- **创建APQ** - 创建一个新的 APQ 组队会话，创建者自动加入
- **加入APQ** - 加入现有的 APQ 组队，需要提供角色信息
- **查询APQ** - 查询当前组队状态和参与者信息
- **我的APQ** - 查询自己的报名状态
- **更换角色** - 更新自己的角色信息
- **退出APQ** - 退出当前APQ组队
- **取消APQ** - 取消当前APQ活动（仅限创建者）

### 管理员功能
- **删除角色** - 删除指定角色（支持角色ID或QQ号）
- **重置APQ** - 完全重置APQ数据

### 特色功能
- **多群聊广播** - 自动记录使用APQ命令的群聊，满员时向所有群聊广播最终名单
- **数据持久化** - 重启后不丢失数据
- **严格格式验证** - 防止信息错位
- **权限分级管理** - 支持超级管理员和群管理员

---

## APQ 规则

- 每个队伍最多 6 人参与
- 参与者必须提供以下信息：
  - **角色ID**: 游戏内角色唯一标识
  - **性别角色**: 新娘(br) 或 新郎(gr)
  - **职业信息**: 角色职业（如：夜行者、火枪手、船长等）
- 当第6个人加入时，自动完成集结并向所有记录的群聊广播最终名单

---

## 安装说明

### 前置要求

- [AstrBot](https://github.com/Soulter236/AstrBot) 框架
- Python 3.8+

### 安装步骤

1. 将插件目录 `astrbot_plugin_mapleroyalsapq` 放入 AstrBot 的 `plugins` 目录
2. 重启 AstrBot 或使用插件重载命令
3. 配置管理员ID（可选）

---

## 配置说明

在 AstrBot 配置中设置超级管理员ID：

```json
{
  "admin_ids": ["123456789", "987654321"]
}
```

超级管理员拥有以下额外权限：
- 更新任意玩家的角色信息
- 删除指定角色
- 重置整个APQ数据

---

## 项目结构

```
astrbot_plugin_mapleroyalsapq/
├── metadata.yaml          # 插件元数据
├── main.py               # 主程序代码
├── _conf_schema.json     # 配置文件模式
├── README.md             # 本文档
└── data/
    └── database.json     # 数据库（运行时生成）
```

---

## 用户命令

### 1. 创建APQ

```
/创建APQ <角色ID> <br/gr/新郎/新娘> <职业>
```

**说明**: 创建一个新的 APQ 组队会话，并自动加入

**参数说明**:
- `角色ID`: 游戏内角色ID（必填）
- `br/gr/新郎/新娘`: 性别角色，支持 br/新娘 或 gr/新郎（必填，不区分大小写）
- `职业`: 角色职业名称（必填）

**示例**:
```
/创建APQ dingzhen gr 拳手
/创建APQ xuebao 新郎 法师
/创建APQ litang br 小号
```

**规则**:
- 每队固定 6 人
- 创建者自动成为队长并加入APQ
- 同时只能有一个APQ活动处于召集中
- 如果已有APQ在召集，第二个人创建时会收到提示：目前已有APQ在召集，请等满员发车后再创建新的
- 用户QQ号会自动记录在database.json中
- 当前群聊ID会被记录到tracked_groups列表中

---

### 2. 加入APQ

```
/加入APQ <角色ID> <br/gr/新郎/新娘> <职业>
```

**说明**: 加入 APQ 组队，需要提供完整的角色信息

**参数说明**:
- `角色ID`: 游戏内角色ID（必填）
- `br/gr/新郎/新娘`: 性别角色，支持 br/新娘 或 gr/新郎（必填，不区分大小写）
- `职业`: 角色职业名称（必填）

**业务逻辑**:
- 如果database.json中没有APQ活动，回复：目前没有进行中的APQ活动，请先创建APQ
- 如果有APQ活动，正常添加信息并回复当前所有已参与的成员信息
- 当第6个人加入时，先广播6人名单到所有记录的群聊，然后重置database.json

**示例**:
```
/加入APQ 12345 br 刀飞
/加入APQ 67890     gr 船长
/加入APQ 12345 新娘       标飞
```

**规则**:
- 必须按正确格式输入（角色ID、性别、职业）
- 参数顺序固定，无法交换
- 支持多个空格分隔
- 代码严格验证格式，信息错位无法参加
- 当前群聊ID会被记录到tracked_groups列表中

---

### 3. 查询APQ

```
/查询APQ
```

**说明**: 查询当前 APQ 组队状态

**显示内容**:
- 队长信息
- 成员列表（含序号、角色ID、性别、职业、QQ号）
- 统计信息（总人数、新娘数、新郎数）
- 当前进度（x/6人）

---

### 4. 我的APQ

```
/我的APQ
```

**说明**: 查询自己的 APQ 报名状态

**显示内容**:
- 当前身份（队长/队员）
- 自己的角色ID、性别、职业信息
- 当前队伍人数

---

### 5. 更换角色

```
/更换APQ角色 <角色ID> <br/gr/新郎/新娘> <职业>
```

**说明**: 更新自己的角色信息

**参数说明**:
- `角色ID`: 新的游戏内角色ID（必填）
- `br/gr/新郎/新娘`: 性别角色（必填）
- `职业`: 新的角色职业名称（必填）

**业务逻辑**:
- 基于QQ号查询并更新对应角色信息
- 如果用户没有加入APQ，回复：你还没有加入APQ组队

**示例**:
```
/更换APQ角色 dingzhen2 gr 拳手
/更换APQ角色 xuebao2 新郎 法师
```

---

### 6. 退出APQ

```
/退出APQ
```

**说明**: 退出当前 APQ 组队

**规则**:
- 队长不能使用此命令，如需取消请使用 `/取消APQ`
- 普通队员可以自由退出
- 退出后数据从成员列表中移除

---

### 7. 取消APQ

```
/取消APQ
```

**说明**: 仅限APQ创建者（队长）使用

**效果**:
- 验证发送者QQ号是否与队长的QQ号一致
- 如果一致，取消当前的 APQ 活动，清空所有数据
- 同时清空tracked_groups列表

---

### 8. 帮助

```
/APQ命令使用帮助
```

**说明**: 显示所有可用命令的帮助信息

---

## 管理员命令

### 删除角色

```
/删除APQ角色 <角色ID或QQ号>
```

**权限**: 超级管理员 或 群管理员

**说明**: 从APQ中移除指定角色

**参数说明**:
- 支持通过角色ID查找并删除
- 支持通过QQ号查找并删除

**特殊规则**:
- 如果删除的角色是队长，则等同于重置APQ
- 删除队长时会同时清空tracked_groups列表

**示例**:
```
/删除APQ角色 dingzhen
/删除APQ角色 123456789
```

---

### 重置APQ

```
/重置APQ
```

**权限**: 超级管理员 或 群管理员

**说明**: 完全重置APQ数据，清空所有活动

**效果**:
- 清空所有APQ数据
- 清空tracked_groups列表
- 准备迎接下一场活动

---

## 多群聊广播功能

### 功能说明

插件会自动记录使用过APQ相关命令的群聊ID（去重存储在 `tracked_groups` 中）。当第6人加入APQ时，系统会向所有记录的群聊广播最终的6人参与名单。

### 工作流程

1. **记录群聊ID**: 任何用户在群聊中使用APQ相关命令时，该群聊ID会被记录
2. **满员广播**: 当第6人加入时，系统构建最终名单并广播到所有记录的群聊
3. **数据重置**: 广播完成后，APQ数据和tracked_groups列表都会被清空，准备下一场活动

### 记录命令列表

以下命令会触发群聊ID记录：
- `/创建APQ`
- `/加入APQ`
- `/查询APQ`
- `/我的APQ`
- `/取消APQ`
- `/退出APQ`
- `/更换APQ角色`
- `/删除APQ角色`
- `/重置APQ`
- `/APQ命令使用帮助`

### 广播消息示例

```
=== APQ 集结完成 ===

1. [dingzhen] gr 拳手 (QQ: 123456)
2. [xuebao] br 法师 (QQ: 234567)
3. [litang] gr 刀飞 (QQ: 345678)
4. [mei] br 标飞 (QQ: 456789)
5. [ming] gr 船长 (QQ: 567890)
6. [fang] br 主教 (QQ: 678901)

【统计】总人数：6，br：3，gr：3

APQ活动已结束，数据已清空，准备下一场活动！
```

---

## 使用场景示例

### 场景一：正常组队流程

```
[群聊A - 玩家A] /创建APQ dingzhen gr 拳手
-> APQ组队已创建！你已成为队长并加入：角色 dingzhen，gr 拳手
   等待其他人加入...

[群聊A - 玩家B] /加入APQ 12345 br 夜行者
-> 已加入APQ！角色：12345，br 夜行者
   当前成员 (2/6)：
   1. [dingzhen] gr 拳手 (QQ: xxx)
   2. [12345] br 夜行者 (QQ: xxx)

[群聊B - 玩家C] /加入APQ 67890 gr 船长
-> 已加入APQ！角色：67890，gr 船长
   当前成员 (3/6)：...

[群聊C - 玩家D] /加入APQ 11111 br 主教
-> 已加入APQ！角色：11111，br 主教
   当前成员 (4/6)：...

[群聊A - 玩家E] /加入APQ 22222 gr 暗影神偷
-> 已加入APQ！角色：22222，gr 暗影神偷
   当前成员 (5/6)：...

[群聊B - 玩家F] /加入APQ 33333 br 复活者
-> === APQ 集结完成 ===
   1. [dingzhen] gr 拳手 (QQ: xxx)
   2. [12345] br 夜行者 (QQ: xxx)
   3. [67890] gr 船长 (QQ: xxx)
   4. [11111] br 主教 (QQ: xxx)
   5. [22222] gr 暗影神偷 (QQ: xxx)
   6. [33333] br 复活者 (QQ: xxx)

   【统计】总人数：6，br：3，gr：3

   APQ活动已结束，数据已清空，准备下一场活动！

(同时，群聊A、群聊B、群聊C都会收到这条广播消息)
```

### 场景二：用户退出组队

```
[玩家] /退出APQ
-> 已退出APQ组队。
```

### 场景三：管理员删除角色

```
[管理员] /删除APQ角色 dingzhen
-> 已将角色 dingzhen(玩家昵称) 从APQ中移除。

[管理员] /删除APQ角色 123456789
-> 已将角色 characterID(玩家昵称) 从APQ中移除。
```

---

## 数据结构

### 参与者信息

```python
{
    "qq_number": "QQ号",
    "nickname": "用户昵称",
    "character_id": "角色ID",
    "gender": "br/gr",  # 新娘/新郎
    "job": "职业"
}
```

### 全局状态

```python
{
    "status": "idle/recruiting",      # 活动状态
    "captain": {
        "qq_number": "队长QQ号",
        "nickname": "队长昵称",
        "character_id": "队长角色ID",
        "gender": "br/gr",
        "job": "队长职业"
    },
    "members": [
        {
            "qq_number": "队员QQ号",
            "nickname": "队员昵称",
            "character_id": "队员角色ID",
            "gender": "br/gr",
            "job": "队员职业"
        },
        ...
    ],
    "tracked_groups": [
        "qq:GroupMessage:群号1",
        "qq:GroupMessage:群号2",
        ...
    ]
}
```

**字段说明**：
- `status`: 活动状态（idle=空闲，recruiting=召集中）
- `captain`: 队长信息（创建APQ的人）
- `members`: 参加者信息列表（包含队长，最多6人）
- `tracked_groups`: 记录的使用APQ命令的群聊ID列表（用于广播）
- 同时只能有一个APQ活动处于召集中

---

## 配置文件说明

### _conf_schema.json

```json
{
  "admin_ids": {
    "type": "list",
    "description": "超级管理员ID列表",
    "items": {
      "type": "string"
    },
    "default": []
  }
}
```

---

## 技术实现

### 核心功能

- 单一会话管理（全局 APQ 组队）
- 数据持久化（JSON 格式存储）
- 管理员权限控制（超级管理员+群管理员）
- 角色信息严格验证（正则表达式匹配）
- 多群聊自动记录和广播
- 满员自动完成并重置

### 权限系统

1. **超级管理员**: 配置文件中 `admin_ids` 指定的用户
2. **群管理员**: 群主、群管理员等拥有群管理权限的用户

### 群聊ID追踪机制

- 每次执行APQ相关命令时，自动记录当前群聊ID
- 使用去重机制避免重复记录同一群聊
- 满员时向所有记录的群聊广播最终名单
- 数据重置时同时清空群聊ID列表

---

## 注意事项

1. APQ 活动需要男女搭配参与
2. 每个队伍最多 6 人
3. 所有用户都可以使用基础命令（创建、加入、查询、更换、退出、取消）
4. 管理员拥有额外权限：删除角色、重置APQ
5. 数据会持久化保存到 `data/database.json`，重启后不丢失
6. 当第6个人加入APQ时，系统会自动完成集结并向所有记录的群聊广播
7. 广播完成后，数据和群聊ID列表都会被清空，准备下一场活动
8. 私聊中使用APQ命令不会记录群聊ID（因为没有群聊）

---

## 常见问题

**Q: 命令提示格式错误？**
A: 确保按照 `角色ID 性别 职业` 的顺序输入，性别只能用 br/gr/新郎/新娘

**Q: 如何查看自己的报名状态？**
A: 使用 `/我的APQ` 命令

**Q: 可以重复报名吗？**
A: 不可以，新的报名会覆盖之前的报名信息

**Q: 怎么退出当前APQ？**
A: 使用 `/退出APQ` 命令（普通队员），或 `/取消APQ` 命令（队长）

**Q: 管理员有什么特殊权限？**
A: 管理员可以删除指定角色、重置整个APQ数据

**Q: 为什么有些群收到了满员广播，有些没有？**
A: 只有使用过APQ相关命令的群聊才会被记录并收到广播

**Q: 如何清空记录的群聊列表？**
A: 使用 `/重置APQ` 或等待满员自动完成，都会清空群聊ID列表

---

## 版本历史

### v1.1.0 (当前版本)
- 新增多群聊广播功能
- 新增 `/退出APQ` 命令
- 新增群聊ID追踪机制（tracked_groups）
- 新增满员自动广播到所有记录群聊
- 优化管理员命令（`/删除APQ角色`）
- 优化数据重置逻辑

### v1.0.0
- 基础组队功能
- 角色信息收集
- 队伍查询和显示
- 管理员权限系统
- 数据持久化

---

## 许可证

本项目采用 MIT 许可证。
